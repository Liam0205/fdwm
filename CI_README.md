# CI/CD 流程说明

## 概述

这个项目使用了改进的 GitHub Actions workflow，提供了完整的 CI/CD 流程，包括测试、代码质量检查、构建和发布。

## Workflow 结构

### 1. 测试阶段 (test)

- **多版本测试**：在 Python 3.8-3.13 上运行测试
- **依赖缓存**：使用 GitHub Actions 缓存加速构建
- **覆盖率报告**：生成代码覆盖率报告并上传到 Codecov
- **并行执行**：使用矩阵策略并行测试多个 Python 版本

### 2. 代码质量检查 (lint)

- **代码格式化**：使用 Black 检查代码格式
- **导入排序**：使用 isort 检查导入语句排序
- **代码风格**：使用 flake8 检查代码风格
- **类型检查**：使用 mypy 进行静态类型检查

### 3. 构建阶段 (build)

- **依赖测试和代码质量检查**：只有通过测试和代码质量检查才会构建
- **包构建**：构建源码分发和轮子分发
- **包检查**：使用 twine 检查构建的包
- **构建产物上传**：将构建产物保存为 artifacts

### 4. 发布阶段 (publish)

- **依赖构建阶段**：只有构建成功才会发布
- **构建产物下载**：下载之前构建的包
- **PyPI 发布**：使用 Trusted Publisher 发布到 PyPI

## 触发条件

- **自动触发**：当创建 release 时自动触发
- **手动触发**：可以通过 GitHub Actions 页面手动触发

## 配置说明

### pyproject.toml 配置

项目使用现代化的 Python 包配置，包括：

- **开发依赖**：pytest、black、flake8、isort、mypy 等
- **工具配置**：Black、isort、mypy、pytest 的配置文件
- **类型检查**：针对第三方库的类型检查忽略配置

### .flake8 配置

- **行长度**：88 字符（与 Black 保持一致）
- **忽略规则**：E203、W503（与 Black 兼容）
- **排除目录**：构建产物、缓存等目录

## 使用说明

### 本地开发

1. **安装开发依赖**：
   ```bash
   pip install -e ".[dev]"
   ```

2. **运行测试**：
   ```bash
   pytest
   ```

3. **代码格式化**：
   ```bash
   black .
   isort .
   ```

4. **代码质量检查**：
   ```bash
   flake8
   mypy fdwm/
   ```

### 发布流程

1. **创建 Release**：在 GitHub 上创建新的 release
2. **自动触发**：workflow 会自动运行测试、构建和发布
3. **验证发布**：检查 PyPI 上的包是否正确发布

## 优势

### 1. 质量保证
- **全面测试**：多版本 Python 测试确保兼容性
- **代码质量**：自动检查代码格式和类型
- **覆盖率**：代码覆盖率报告帮助提高代码质量

### 2. 效率提升
- **依赖缓存**：减少重复下载，加速构建
- **并行执行**：多版本测试并行执行
- **条件执行**：只有通过前置检查才会继续

### 3. 安全性
- **Trusted Publisher**：使用 PyPI 的 Trusted Publisher 机制
- **权限控制**：最小权限原则，只授予必要的权限
- **环境隔离**：使用 GitHub Environments 管理发布环境

### 4. 可维护性
- **清晰结构**：workflow 结构清晰，易于理解和维护
- **配置集中**：所有工具配置集中在 pyproject.toml 中
- **文档完善**：详细的配置说明和使用指南

## 故障排除

### 常见问题

1. **测试失败**：检查依赖是否正确安装，测试环境是否配置正确
2. **代码质量检查失败**：运行 `black .` 和 `isort .` 格式化代码
3. **类型检查失败**：添加类型注解或使用 `# type: ignore` 注释
4. **构建失败**：检查 pyproject.toml 配置是否正确

### 调试技巧

1. **查看日志**：在 GitHub Actions 页面查看详细的执行日志
2. **本地复现**：在本地环境中复现问题
3. **分步调试**：逐个检查每个步骤的输出

## 未来改进

1. **安全扫描**：添加依赖安全扫描
2. **性能测试**：添加性能基准测试
3. **文档构建**：自动构建和发布文档
4. **Docker 支持**：添加 Docker 镜像构建 